<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>哇哈哈</title>
    <link rel="stylesheet" href="static/style.css">
    <link rel="stylesheet" href="static/chart-fix.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
</head>
<body>

<div class="app-layout">
    
    <header class="top-bar">
        <div class="brand">🚀 哇哈哈 Pro</div>
        
        <nav class="main-nav">
            <button class="nav-tab active" data-target="view-selection">🎯 选股页签</button>
            <button class="nav-tab" data-target="view-backtest">📊 回测页签</button>
            <button class="nav-tab" data-target="view-holdings">💼 持仓页签</button>
            <button class="nav-tab" data-target="view-stock-query">🔍 股票经营内容查询</button>
            <button class="nav-tab" data-target="view-industry-rotation">🔄 行业轮动（按月）</button>
            <button class="nav-tab" data-target="view-value-growth">📈 价值/成长股筛选</button>

        </nav>

        <div class="global-actions">
            <!--<button class="help-btn" id="help-btn" title="查看系统说明">❓</button>-->
            <input type="password" id="tushareToken" placeholder="Tushare Token" class="input-dark">
            <button class="btn btn-success" id="api-update-data">🔄 更新数据</button>
            <div class="connection-status-indicator">
                <span class="status-dot"></span>
                <span class="status-text">未连接</span>
            </div>
            <span class="last-update-time">
                ⏱ 上次更新：<span id="last-update-text">--</span>
            </span>
        </div>
    </header>

    <div class="workspace">

        <div id="view-selection" class="view-container active">
            <aside class="sidebar"  style="resize: horizontal; overflow: hidden;"  id="resizable-sidebar">
                <div class="panel-header">
                    <span>📝 买入条件配置</span>
                    <div class="mini-tools">
                        <button class="icon-btn" id="api-export-buy-config">💾</button>
                        <button class="icon-btn" id="api-import-buy-config">📥</button>
                    </div>
                </div>
                
                
                <div class="config-list" id="buy-factor-container"></div>
                <div class="panel-footer">
                    <button class="btn btn-primary" id="btn-add-buy-factor">
                        <i class="fas fa-plus"></i> 添加买入因子组合
                    </button>
                </div>
            </aside>

            <main class="main-content">


            <!-- ========== 新增：筛选和权重设置区域 ========== -->
            <div class="filter-and-threshold-panel">
                <div class="filter-section">
                    <div class="section-title">🔍 股票筛选(日线信息没有北交所)</div>
                    <div class="filter-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-exclude-st" checked> 剔除ST股
                        </label>
                    </div>
                    <div class="filter-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-exclude-kc" checked> 剔除科创板
                        </label>
                    </div>
                    <div class="filter-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-exclude-cy" checked> 剔除创业板
                        </label>
                    </div>
                    <div class="filter-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-exclude-value" checked> 只计算价值股
                        </label>
                    </div>
                    <div class="filter-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-exclude-grow" checked> 只计算成长股
                        </label>
                    </div>

                </div>

                <div class="threshold-section">
                    <div class="section-title">📊 权重阈值设置</div>
                    <div class="threshold-slider-group">
                        <div class="threshold-label-row">
                            <span class="threshold-label">权重值</span>
                            <span class="threshold-value-display" id="threshold-value-display">0.5</span>
                        </div>
                        <input type="range" id="weight-threshold-slider" 
                            class="threshold-slider" 
                            min="0" max="1" step="0.01" value="0.5">
                        <div class="threshold-info">
                            <small>拖动滑条设置权重阈值范围（0-1）</small>
                        </div>
                    </div>
                </div>
            </div>



                
                <!-- 说明区域 -->
                <!--<div class="stock-description-area">
                    <div class="section-title">📌 股票说明</div>
                    <textarea id="stock-description" class="description-textarea" placeholder="点击下方股票后在此输入分析说明..."></textarea>
                </div>-->
                
                <button class="btn btn-primary btn-sm" id="api-run-selection">开始选股</button>
                <div class="result-area">
                    <div class="table-header">
                        <span>选股结果</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr><th>代码</th><th>名称</th><th>现价</th><th>综合得分</th><th>行业</th></tr>
                        </thead>
                        <tbody id="selection-result-table"></tbody>
                    </table>
                </div>

                <div class="chart-wrapper">
                    <div class="chart-area">
                        <div class="section-title">📉 K线走势图</div>
                        <div id="klineChart" class="echarts-full-container"></div>
                    </div>
                </div>

                <!--<div class="result-area industry-analysis-area">
                <div class="table-header">
                    <span>行业分析</span>
                    <button class="btn btn-primary btn-sm" id="api-run-industry-analysis">📊 分析行业</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>行业名称</th>
                            <th>股数量</th>
                            <th>行业成交量增长</th>
                            <th>涨跌股数</th>
                            <th>涨跌比例</th>
                            <th>平均涨幅</th>
                        </tr>
                    </thead>
                    <tbody id="industry-analysis-table"></tbody>
                </table>
                </div>-->
            </main>
        </div>

        <div id="view-backtest" class="view-container">
            <aside class="sidebar">
                <div class="panel-header">⚙️ 回测策略源</div>
                <div class="config-form">
                    <div class="form-item">
                        <label>买入策略</label>
                        <select id="backtest-buy-source" class="input-dark">
                            <option value="current">使用当前选股页配置</option>
                        </select>
                        <button class="btn btn-sm btn-outline" id="api-load-buy-file">📂 加载文件</button>
                    </div>
                    <div class="form-item">
                        <label>卖出策略</label>
                        <select id="backtest-sell-source" class="input-dark">
                            <option value="current">使用当前持仓页配置</option>
                        </select>
                        <button class="btn btn-sm btn-outline" id="api-load-sell-file">📂 加载文件</button>
                    </div>
                </div>
                
                <div class="initial-fund-section">
                    <div class="section-title">💰 初始本金设置</div>
                    <div class="fund-input-group">
                        <input type="number" id="initialFundInput" class="fund-input" value="100000">
                        <button class="btn" id="setInitialFundBtn">设置</button>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div class="toolbar">
                    <div class="tool-group">
                        <label>时间范围</label>
                        <input type="date" id="bt-start-date" class="input-dark">
                        <span>至</span>
                        <input type="date" id="bt-end-date" class="input-dark">
                    </div>
                    <div class="tool-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="bt-is-ideal"> 是否为理想买入卖出
                        </label>
                    </div>
                    <button class="btn btn-primary" id="api-run-backtest">▶ 开始回测</button>
                </div>
                
                <div class="chart-wrapper">
                    <div class="chart-area portfolio-chart">
                        <div class="section-title">📈 收益走势图</div>
                        <div id="portfolioChart" class="echarts-full-container"></div>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="label">最终总盈亏</div>
                        <div class="value highlight" id="res-total-pnl">0.00%</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">胜率</div>
                        <div class="value" id="res-win-rate">0%</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">最大回撤</div>
                        <div class="value down" id="res-max-drawdown">0.00%</div>
                    </div>
                </div>

                <div class="table-area">
                    <div class="section-title">📃 回测交易流水</div>
                    <table class="data-table">
                        <thead>
                            <tr><th>日期</th><th>股票</th><th>动作</th><th>价格</th><th>收益</th><th>当前权益</th></tr>
                        </thead>
                        <tbody id="backtest-log-table"></tbody>
                    </table>
                </div>
            </main>
        </div>

        <div id="view-holdings" class="view-container">
            <aside class="sidebar">
                <div class="panel-header">
                    <span>✂️ 卖出策略配置</span>
                    <div class="mini-tools">
                        <button class="icon-btn" id="api-export-sell-config">💾</button>
                        <button class="icon-btn" id="api-import-sell-config">📥</button>
                    </div>
                </div>


                <div class="config-list" id="sell-factor-container"></div>
                <div class="panel-footer">
                    <button class="btn btn-primary" id="btn-add-sell-factor">
                        <i class="fas fa-plus"></i> 添加卖出因子组合
                    </button>
                </div>
            </aside>

            <main class="main-content">


            <div class="threshold-section">
                    <div class="section-title">📊 权重阈值设置</div>
                    <div class="threshold-slider-group">
                        <div class="threshold-label-row">
                            <span class="threshold-label">权重值</span>
                            <span class="threshold-value-display" id="holdings-threshold-value-display">0.5</span>
                        </div>
                        <input type="range" id="holdings-weight-threshold-slider" 
                            class="threshold-slider" 
                            min="0" max="1" step="0.01" value="0.5">
                        <div class="threshold-info">
                            <small>拖动滑条设置权重阈值范围（0-1）</small>
                        </div>
                    </div>
                </div>



                <div class="holdings-top">
                    <div class="section-title">💼 当前持仓明细</div>
                    <button class="btn btn-danger" id="api-diagnose-holdings">🩺 卖出策略诊断</button>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>代码</th><th>名称</th><th>买入价</th><th>买入日期</th>
                            <th>当前价</th><th>涨幅</th><th>盈利额</th><th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="holdings-table"></tbody>
                </table>

                <div class="diagnosis-panel">
                    <div class="section-title">📈 策略执行结果预演</div>
                    <div id="diagnosis-output" class="diagnosis-content">
                        等待诊断执行...
                    </div>
                </div>
            </main>
        </div>


        <div id="view-stock-query" class="view-container">
            <aside class="sidebar">
                <div class="panel-header">🔍 股票查询</div>
                
                <div class="config-form" style="padding: 14px;">
                    <div class="form-item">
                        <label>股票代码或名称</label>
                        <input type="text" id="query-stock-input" 
                            class="input-dark" 
                            placeholder="输入股票代码（如000001）或名称">
                        <button class="btn btn-primary" style="width: 100%; margin-top: 8px;" 
                                id="btn-query-stock">
                            🔍 查询
                        </button>
                    </div>
                    
                    <div class="form-item" style="margin-top: 16px; border-top: 1px solid rgba(79, 172, 254, 0.2); padding-top: 12px;">
                        <label>快速查询</label>
                        <div class="quick-query-buttons">
                            <input type="text" id="quick-query-input" 
                                class="input-dark" 
                                placeholder="输入代码搜索">
                        </div>
                        <div id="quick-query-results" class="quick-query-list"></div>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div id="stock-query-result" class="stock-query-panel">
                    <div class="section-title">📋 股票信息详情</div>
                    <div class="stock-info-container">
                        <div class="stock-header-info">
                            <div class="stock-name-code">
                                <h2 id="query-stock-name">-</h2>
                                <span id="query-stock-code" class="stock-code-tag">-</span>
                            </div>
                            <div class="stock-price-info">
                                <div class="price-item">
                                    <span class="label">当前价格</span>
                                    <span id="query-stock-price" class="value highlight">-</span>
                                </div>
                                <div class="price-item">
                                    <span class="label">涨跌幅</span>
                                    <span id="query-stock-change" class="value">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="stock-details-grid">
                            <div class="info-card">
                                <span class="label">行业</span>
                                <span id="query-stock-industry" class="value">-</span>
                            </div>
                            <div class="info-card">
                                <span class="label">市盈率(PE)</span>
                                <span id="query-stock-pe" class="value">-</span>
                            </div>
                            <div class="info-card">
                                <span class="label">市净率(PB)</span>
                                <span id="query-stock-pb" class="value">-</span>
                            </div>
                            <div class="info-card">
                                <span class="label">总市值</span>
                                <span id="query-stock-market-cap" class="value">-</span>
                            </div>
                            <div class="info-card">
                                <span class="label">流通市值</span>
                                <span id="query-stock-circulate-cap" class="value">-</span>
                            </div>
                            <div class="info-card">
                                <span class="label">52周高</span>
                                <span id="query-stock-52high" class="value">-</span>
                            </div>
                        </div>

                        <div class="company-section">
                            <div class="section-title">公司简介</div>
                            <textarea id="query-company-intro" class="description-textarea" 
                                    placeholder="公司简介信息..." readonly></textarea>
                        </div>

                        <div class="products-section">
                            <div class="section-title">主要产品/业务</div>
                            <div id="query-products-list" class="products-list">
                                <div class="empty-state">暂无产品信息</div>
                            </div>
                        </div>

                        <div class="business-section">
                            <div class="section-title">业务分析</div>
                            <textarea id="query-business-analysis" class="description-textarea" 
                                    placeholder="业务分析信息..." readonly></textarea>
                        </div>
                    </div>
                </div>
            </main>
        </div>


        <!-- ============= 新页签5：行业轮动分析 ============= -->
        <div id="view-industry-rotation" class="view-container">
            <aside class="sidebar">
                <div class="panel-header">🔄 行业轮动设置</div>
                <div class="config-form" style="padding: 14px;">
                    <div class="form-item">
                        <label>选择月份</label>
                        <input type="month" id="rotation-month-input" class="input-dark">
                    </div>
                    <div class="form-item">
                        <label>轮动周期</label>
                        <select id="rotation-period" class="input-dark">
                            <option value="1">1个月</option>
                            <option value="3" selected>3个月</option>
                            <option value="6">6个月</option>
                            <option value="12">1年</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 10px;">📊 分析轮动</button>
                </div>
            </aside>
            <main class="main-content">
                <div class="chart-area">
                    <div class="section-title">📊 行业轮动柱状图</div>
                    <div id="industryRotationChart" class="echarts-full-container"></div>
                </div>
                <div class="result-area">
                    <div class="table-header">
                        <span>行业轮动数据</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>行业名称</th>
                                <th>前期表现</th>
                                <th>当期表现</th>
                                <th>涨跌</th>
                                <th>轮动建议</th>
                            </tr>
                        </thead>
                        <tbody id="industry-rotation-table"></tbody>
                    </table>
                </div>
            </main>
        </div>

        <!-- ============= 新页签6：价值股 & 成长股筛选 ============= -->
        <div id="view-value-growth" class="view-container">
            <aside class="sidebar">
                <div class="panel-header">📈 筛选条件</div>
                <div class="config-form" style="padding: 14px;">
                    <div class="form-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-value-stock" checked> 价值股
                        </label>
                    </div>
                    <div class="form-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-growth-stock" checked> 成长股
                        </label>
                    </div>
                    <div class="form-item">
                        <label>PE范围</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="pe-min" placeholder="最小" class="input-dark" min="0">
                            <input type="number" id="pe-max" placeholder="最大" class="input-dark" min="0">
                        </div>
                    </div>
                    <div class="form-item">
                        <label>市净率范围</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="pb-min" placeholder="最小" class="input-dark" min="0" step="0.1">
                            <input type="number" id="pb-max" placeholder="最大" class="input-dark" min="0" step="0.1">
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 10px;">🔍 筛选股票</button>
                </div>
            </aside>
            <main class="main-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="info-card" style="padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: var(--text-dim);">💎 价值股数量</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #ff1493;">--</div>
                    </div>
                    <div class="info-card" style="padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: var(--text-dim);">🚀 成长股数量</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #ff69b4;">--</div>
                    </div>
                </div>
                <div class="result-area">
                    <div class="table-header">
                        <span>价值股 & 成长股列表</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>代码</th>
                                <th>名称</th>
                                <th>PE</th>
                                <th>PB</th>
                                <th>类型</th>
                                <th>行业</th>
                            </tr>
                        </thead>
                        <tbody id="value-growth-table"></tbody>
                    </table>
                </div>
            </main>
        </div>

    </div>

    <footer class="log-panel">
        <div class="log-header">
            <span>控制台日志 (Console)</span>
            <button class="btn-clear" id="btn-clear-log">清空日志</button>
        </div>
        <div class="log-body" id="global-log-container">
            <div class="log-item system">[系统] 界面初始化完成...</div>
        </div>
    </footer>

</div>

<!--<div class="modal-overlay" id="factor-modal">
    <div class="modal-content">
        <h3>选择因子类型</h3>
        <div class="factor-type-grid" id="factor-type-list"></div>
        <button class="btn btn-secondary" id="btn-close-modal">取消</button>
    </div>
</div>
-->

<!-- 因子选择模态框（改进版 - 支持分类和滚动） -->
<div id="factor-modal" class="modal">
    <div class="modal-content factor-modal-content">
        <div class="modal-header">
            <h3>📊 选择筛选因子（“当日”开头的指标只会计算最新日期，不会考虑因子设置的日期区间）</h3>
            <span class="close" id="btn-close-modal">&times;</span>
        </div>
        
        <!-- 分类容器（可滚动） -->
        <div id="factor-categories-container" class="factor-categories-container">
            <!-- 分类和因子列表会动态生成在这里 -->
        </div>
    </div>
</div>





    <!-- 说明弹窗（静态） -->
    <div id="help-modal" class="help-modal">
        <div class="help-modal-overlay" onclick="closeHelpModal()"></div>
        
        <div class="help-modal-content">
            <!-- 头部 -->
            <div class="help-modal-header">
                <h2>❓ 系统说明</h2>
                <button class="help-modal-close" onclick="closeHelpModal()">✕</button>
            </div>
            
            <!-- 页签导航 -->
            <div class="help-tabs-nav">
                <button class="help-tab-btn active" onclick="switchHelpTab('overview')">
                    📋 概览
                </button>
                <button class="help-tab-btn" onclick="switchHelpTab('selection')">
                    🎯 选股说明
                </button>
                <button class="help-tab-btn" onclick="switchHelpTab('backtest')">
                    📊 回测说明
                </button>
                <button class="help-tab-btn" onclick="switchHelpTab('holdings')">
                    💼 持仓管理
                </button>
                <button class="help-tab-btn" onclick="switchHelpTab('factors')">
                    🔧 因子详解
                </button>
            </div>
            
            <!-- 页签内容 -->
            <div class="help-tabs-content">
                
                <!-- 页签1：概览 -->
                <div id="help-tab-overview" class="help-tab-pane active">
                    <div class="help-content">
                        <h3>🎯 系统功能概览</h3>
                        <p>你的文本内容在这里...</p>
                        <!-- 更多内容 -->
                    </div>
                </div>
                
                <!-- 页签2：选股说明 -->
                <div id="help-tab-selection" class="help-tab-pane">
                    <div class="help-content">
                        <h3>🎯 选股系统使用说明</h3>
                        <p>你的文本内容在这里...</p>
                    </div>
                </div>
                
                <!-- 页签3：回测说明 -->
                <div id="help-tab-backtest" class="help-tab-pane">
                    <div class="help-content">
                        <h3>📊 回测系统使用说明</h3>
                        <p>你的文本内容在这里...</p>
                    </div>
                </div>
                
                <!-- 页签4：持仓管理 -->
                <div id="help-tab-holdings" class="help-tab-pane">
                    <div class="help-content">
                        <h3>💼 持仓管理说明</h3>
                        <p>你的文本内容在这里...</p>
                    </div>
                </div>
                
                <!-- 页签5：因子详解 -->
                <div id="help-tab-factors" class="help-tab-pane">
                    <div class="help-content">
                        <h3>🔧 因子系统详解</h3>
                        <p>你的文本内容在这里...</p>
                    </div>
                </div>
                
            </div>
            
            <!-- 底部 -->
            <div class="help-modal-footer">
                <button class="btn btn-secondary" onclick="closeHelpModal()">
                    关闭
                </button>
            </div>
        </div>
    </div>

    
    <script type="module">
        import AppManager from "./static/AppManager.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            AppManager.init();
            window.AppManager = AppManager;  // 便于在onclick中使用
        });
    </script>
</body>
</html>
